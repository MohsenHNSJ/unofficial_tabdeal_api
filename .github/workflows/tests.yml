name: Tests

on:
  push:
  pull_request:

jobs:
    build-tests:
        name: ${{ matrix.session }}
        runs-on: ubuntu-latest
        strategy:
            fail-fast: false
            matrix:
                include:
                    - { session: "pre-commit"}
                    - { session: "ruff_check" }
                    - { session: "docs_build" }
                    - { session: "mypy_type" }
                    - { session: "test" }

        env:
            NOXSESSION: ${{ matrix.session }}
            FORCE_COLOR: "1"
            PRE_COMMIT_COLOR: "always"

        steps:
            - name: Check out the repository
              uses: actions/checkout@v4.2.2

            - name: Set up Python 3.13
              uses: actions/setup-python@v5.5.0
              with:
                python-version: "3.13"
                check-latest: true

            - name: Upgrade pip if necessary
              run: |
                pip install --constraint=.github/workflows/constraints.txt pip
                pip --version

            - name: Capture Python version
              run: echo "PYTHON_VERSION=$(python --version | awk '{print $2}')" >> "$GITHUB_ENV"

            - name: Install Poetry
              run: |
                pipx install --pip-args=--constraint=.github/workflows/constraints.txt --python ${{ env.PYTHON_VERSION }} poetry
                pipx inject poetry poetry-plugin-export
                poetry --version

            - name: Install Nox
              run: |
                pipx install --pip-args=--constraint=.github/workflows/constraints.txt --python ${{ env.PYTHON_VERSION }} nox
                pipx inject --pip-args=--constraint=.github/workflows/constraints.txt nox nox-poetry
                nox --version

            - name: Run Nox
              run: |
                nox --python=3.13

    compatibility-tests:
      name: Compatibility with Python ${{ matrix.python-version }}
      runs-on: ubuntu-latest
      strategy:
        fail-fast: false
        matrix:
          python-version: ["3.11", "3.12", "3.13"]

      env:
        NOXSESSION: test_and_coverage
        FORCE_COLOR: "1"
        PRE_COMMIT_COLOR: "always"

      steps:
        - name: Check out the repository
          uses: actions/checkout@v4.2.2

        - name: Set up Python ${{ matrix.python-version }}
          uses: actions/setup-python@v5.5.0
          with:
            python-version: ${{ matrix.python-version }}
            check-latest: true

        - name: Upgrade pip if necessary
          run: |
            pip install --constraint=.github/workflows/constraints.txt pip
            pip --version

        - name: Capture Python version
          run: echo "PYTHON_VERSION=$(python --version | awk '{print $2}')" >> "$GITHUB_ENV"

        - name: Install Poetry
          run: |
            pipx install --pip-args=--constraint=.github/workflows/constraints.txt --python ${{ env.PYTHON_VERSION }} poetry
            pipx inject poetry poetry-plugin-export
            poetry --version

        - name: Install Nox
          run: |
            pipx install --pip-args=--constraint=.github/workflows/constraints.txt --python ${{ env.PYTHON_VERSION }} nox
            pipx inject --pip-args=--constraint=.github/workflows/constraints.txt nox nox-poetry
            nox --version

        - name: Run Nox
          run: |
            nox -s test-${{ matrix.python-version }}



        - name: Upload coverage data
          uses: actions/upload-artifact@v4.6.2
          with:
            name: coverage-data${{ env.PYTHON_VERSION }}
            path: ".coverage.*"
            include-hidden-files: true
            compression-level: 0

    coverage:
      name: Produce coverage report
      runs-on: ubuntu-latest
      needs: compatibility-tests
      permissions:
        id-token: write
      steps:
        - name: Check out the repository
          uses: actions/checkout@v4.2.2

        - name: Set up Python 3.13
          uses: actions/setup-python@v5.5.0
          with:
            python-version: "3.13"
            check-latest: true

        - name: Upgrade pip if necessary
          run: |
            pip install --constraint=.github/workflows/constraints.txt pip
            pip --version

        - name: Capture Python version
          run: echo "PYTHON_VERSION=$(python --version | awk '{print $2}')" >> "$GITHUB_ENV"

        - name: Install Poetry
          run: |
            pipx install --pip-args=--constraint=.github/workflows/constraints.txt --python ${{ env.PYTHON_VERSION }} poetry
            pipx inject poetry poetry-plugin-export
            poetry --version

        - name: Install Nox
          run: |
            pipx install --pip-args=--constraint=.github/workflows/constraints.txt --python ${{ env.PYTHON_VERSION }} nox
            pipx inject --pip-args=--constraint=.github/workflows/constraints.txt nox nox-poetry
            nox --version

        - name: Download coverage data
          uses: actions/download-artifact@v4.2.1
          with:
            pattern: coverage-data*

        - name: Move coverage files to root folder
          run: |
            find ~/ -type f -name '.coverage.*' -exec mv -t /home/runner/work/unofficial_tabdeal_api/unofficial_tabdeal_api/ {} +

        - name: Combine coverage data and report
          run: |
            nox -s coverage-3.13

        - name: Update signature keys
          # Request updates from a keyserver for keys that already exist on the local keyring.
          # This is useful for updating a key with the latest signatures, user IDs, etc.
          # Calling this with no arguments will refresh the entire keyring.
          # gpg --refresh-keys
          # Do trust database maintenance without user interaction.
          # From time to time the trust database must be updated so that expired keys or signatures and the resulting changes in the Web of Trust can be tracked.
          # Normally, GnuPG will calculate when this is required and do it automatically unless --no-auto-check-trustdb is set.
          # This command can be used to force a trust database check at any time.
          # The processing is identical to that of --update-trustdb but it skips keys with a not yet defined "ownertrust".
          run: |
            gpg --check-trustdb

        - name: Upload coverage report To Codecov
          uses: codecov/codecov-action@v5.4.0
          with:
            # Disable search for coverage files.
             #This is helpful when specifying what files you want to upload with the files option.
            disable_search: true
            # On error, exit with non-zero code
            fail_ci_if_error: true
            # Comma-separated explicit list of files to upload.
            # These will be added to the coverage files found for upload.
            # If you wish to only upload the specified files, please consider using "disable-search" to disable uploading other files.
            files: ./coverage.xml
            # Use OIDC instead of token. This will ignore any token supplied
            use_oidc: true
            # Enable verbose logging
            verbose: true
